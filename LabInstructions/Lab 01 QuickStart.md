## Lab 1 - QuickStart - OpenAI

- In this exercise you will create a simple Spring Boot application which can make calls to OpenAI.  You will need to establish credentials with OpenAI first, so let's take care of that now.


---
**Part 1 - Obtain an Account with OpenAI**

Begin by establishing an account with OpenAI. Follow the instructions in the **[Lab Setup guide](https://github.com/kennyk65/AI-With-Spring-Student-Files/blob/main/LabInstructions/Lab%20Setup.md)** _Setup Process for OpenAI_ section to establish an account and set credentials in your local environment

WARNING: Do not use the instructions for "Azure OpenAI" at this point; they will not match the instructions below.  We will see some Azure examples later in the course.

---
**Part 2 - Generate the Project Structure**

1.  Use [https://start.spring.io](https://start.spring.io), create a new Spring Boot Project.
  - Use either Maven or Gradle - Groovy (if you have it installed).  All lab instructions are based on Maven.
  - Use the latest stable releases of Boot and Java.  These instructions were originally tested with Java 1.21, Boot 3.2.5.  The version can be changed after the project is generated.
  - Use JAR packaging.
  - For project metadata, adjust the values as you like.  These instructions will assume an artifact and name of “lab01-openai”.
  - Adjust the package to `com.example` for simplicity.  Feel free to re-arrange the package structure later, but the remaining instructions will assume the former.
  - Search for and select the `OpenAI` dependency. (Do **NOT** select the Azure OpenAI for this lab!)
2. Generate.  Find the downloaded zip and expand it.  Copy the `lab01-openai` project to your _/AI-With-Spring-Student-Files/_ folder, or wherever you downloaded your labfiles to.

---
**Part 3 - Import into your IDE**

The project structure generated by Spring Initializr follows a Maven-type generic pattern and can be imported into various IDEs. You can use either VS Code (assuming the appropriate extensions are installed, see "IDE Tips"), IntelliJ, or Eclipse. 

The instructions below are for VS Code. If you wish to use IntelliJ or Eclipse and need assistance, see the "IDE Tips" document.

3. Open the _/student-files/lab01-openai_ folder / project. 
    - Give the IDE a moment to initialize its workspace and download dependencies, especially if this is the first time importing a Gradle/Maven project.
    - If you see a message about enabling null analysis for the project, you can select either enable or disable.
    - If you see a message about installing Extension Pack for Java, take the install option.
    - If you see a message Do you trust the authors of the files in this folder, check the checkbox and click the "trust" button.

-   The project should be free of compiler errors at this point.  Address any issues you see before continuing.

---
**Part 4 - Basic Configuration and Test**

At this point, let's take a moment to ensure that everything we have created so far is error free.

4.  Within your IDE, find the `src/main/resources/application.properties`.  Rename this file as `src/main/resources/application.yml`.

-   Spring AI doesn't require application.yml vs application.properties, but we'll use YML format in this course.

5.  Establish the following entries:

```
spring:
  application.name: Lab01 OpenAI
  main.web-application-type: none     # Do not start a web server.

  ai:
    retry:
      max-attempts: 1           # Maximum number of retry attempts.
```
- Be sure you have completed the Lab Setup steps for obtaining OpenAI API key and setting it as an environment variable.  We could store the API key value here in `application.yml`, but this would be a security risk if we were to ever distribute this file.  Setting this value in an environment variable is safer.
- Note: The retry* settings will override the `ChatClient`'s default settings.  You are likely to experience errors while you learn the API's usage, and we don't want you to experience unnecessary delay or expense.
6.  Save your work.  

7.  Find the main application class in `src/main/java/com/example`.  It is probably named `Lab01OpenaiApplication.java` if you have followed theses instructions (We usually rename ours to `Application.java`). Run the application.
* **VS Code**: Right-click, Run Java.  Or open the file and click the “Run” option hovering over the main() method.
* **IntelliJ**: Right-click, select “Run ‘Application.main()’”. 
* **Eclipse**: Right-click, Select Run As / Java Application.

* We expect the application to start, then stop, without errors.  If you have any errors related to tooling, be sure to address them now before proceeding.

---
**Part 5 - Try Spring AI's `ChatClient`**

At this point we should be able to try using the ChatClient to make API calls to OpenAI.

8. Create a new  **client**  folder under `src/main/java/com/example`.
1. Within this package create a new Java file called `MyClient.java`.
    * The IDE should create an empty Java class definition for you.
1. Add the following annotations at the class level to make this object a Spring Bean created only when the "openai" profile is active:
```
@Component
@Profile("openai")
public class MyClient {
``` 
- Note: the `@Profile` annotation will be useful later when we want our application to switch between OpenAI, Azure, Ollama, etc.
11. Add code to define a `ChatClient` as a private, final variable.  Spring AI provides a `ChatClient.Builder` that we can use to quickly create it in the constructor.  We will inject the constructor with a `ChatModel` which is created for us by autoconfiguration based on the dependencies.  There are many settings that we can configure on the `ChatClient`, but we will just take the defaults for now:
```
    private final ChatClient client;

    public MyClient(ChatModel model) {
        client = ChatClient.builder(model).build();
    }

```
12. Add a `call` method.  
    - Define a String parameters for the user input / query. 
    - Use the `client` to call the Foundational Model.
    - prompt() creates a prompt to pass
    - user() sets the "user" message. Pass the given input String.
    - call() invokes the model.  It returns a CallResponse.
    - content() is a simple means of extracting String content from the response. 
```
    public String call(String input) {
        return client
                .prompt()
                .user(input)
                .call()
                .content();
    }
```


13. Supply any imports needed to make the code compile.
* **VS Code**: Type Alt-Shift-O.
* **IntelliJ**: Type Ctrl-Alt-O.
* **Eclipse**: Type Ctrl-Shift-O.
14. Save your work.

---
**Part 6 - Create a `@Test` class**

Anything we code, we should test.  We will make a `@Test` class to ensure our Client object works as expected.

15. Create a new  **client**  folder under `src/test/java/com/example`.  Within this package create a new Java file called `MyClientTests.java`.
* The IDE should create an empty Java class definition for you.
* Be sure you are working in the **test** folder.

16. Alter the test class to include the `@SpringBootTest` annotation. Tell boot to activate the 'openai' profile:
```
@SpringBootTest
@ActiveProfiles("openai")
public class MyClientTests {
    
```	
- Note that usage of the @Profile and @ActiveProfile are not strictly requied for this lab, but coming labs will use these to keep the different types of clients separate. 

17. Add code to automatically provide a reference to the `MyClient`:
```
    @Autowired 
	MyClient client;
```
Add a `@Test` method to use the `openAIClient` to make an example API call:
```
    @Test
    public void testCall() {
        String response = client.call(
            "What are the names of the five great lakes.  Produce JSON output.");
        Assertions.assertThat(response).contains(
            "Superior", "Huron", "Erie", "Michigan", "Ontario");
        System.out.println("The response is: " + response);
    }
```
- The `Assertions` class comes from the AssertJ library, `org.assertj.core.api.Assertions`.

18. Supply any imports needed to make you code compile.
    * **VS Code**: Type Alt-Shift-O.
    * **IntelliJ**: Type Ctrl-Alt-O.
    * **Eclipse**: Type Ctrl-Shift-O.

1.  Save your work. Run the test.
    * **VS Code**: In the "explorer" view on the left, Right-click on the class, Select "Run Tests".  Or, find the green triangle in the editor’s “gutter”. Click on this to run either an individual test method or all tests in the class.
    * **IntelliJ**: Right-click on the class. Select Run OpenAIClientTests.
    * **Eclipse**: Right-click on the class. Select Run As / Junit Test.

The test should run and produce a list of the five Great Lakes.  It is also very possible that you will encounter an error here, possibly due to setup, but also due to changes in OpenAPI since the time of this writing.  Here are some troubleshooting tips.
* If you have a compilation issue, be sure you have organized imports.  Compare your code to the solution code.
* If you receive a message that your token is invalid, be sure that your environment variable is being picked up.  Restart your IDE to check. Return to the earlier steps to create a token and set it in an environment variable.
* If you receive a message about exceeding your quota, you may need to convert to a paid subscription for OpenAI (We've had to do this, since we use it heavily).

**Part 7 - Summary**

At this point, you have integrated with one of OpenAI's models to make use of AI from your own Spring Boot application.  Congratulations! 